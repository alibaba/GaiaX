# 尺寸系统

<cite>
**Referenced Files in This Document**   
- [GXSize.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXSize.kt)
- [GXStyleConvert.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXStyleConvert.kt)
- [GXFlexBox.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXFlexBox.kt)
- [GXStyle.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXStyle.kt)
- [GXTemplateKey.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXTemplateKey.kt)
- [GXScreenUtils.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/utils/GXScreenUtils.kt)
- [GXRegisterCenter.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/GXRegisterCenter.kt)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件分析](#核心组件分析)
3. [尺寸单位处理逻辑](#尺寸单位处理逻辑)
4. [屏幕适配与动态缩放机制](#屏幕适配与动态缩放机制)
5. [GXStyleConvert协同工作机制](#gxstyleconvert协同工作机制)
6. [初学者入门指南](#初学者入门指南)
7. [高级开发者指南](#高级开发者指南)
8. [实际应用示例](#实际应用示例)
9. [结论](#结论)

## 简介
GaiaX Android尺寸系统是实现跨设备响应式布局的核心机制，通过GXSize类和GXStyleConvert类的协同工作，为开发者提供了灵活、高效的尺寸定义和处理能力。该系统支持pt、px、百分比等多种尺寸单位，结合屏幕适配策略和动态缩放机制，确保UI在不同设备上的一致性和美观性。

## 核心组件分析

### GXSize类
GXSize类是GaiaX尺寸系统的核心数据结构，负责封装和处理各种尺寸单位。它通过密封类（sealed class）的设计，支持多种尺寸类型，包括PX、PT、PE、Auto和Undefined。

**Section sources**
- [GXSize.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXSize.kt#L29-L136)

### GXStyleConvert类
GXStyleConvert类负责将CSS样式中的尺寸值转换为GXSize对象，并提供了一系列静态方法来处理不同的样式属性。

**Section sources**
- [GXStyleConvert.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXStyleConvert.kt#L40-L508)

## 尺寸单位处理逻辑

### PX单位处理
PX单位是基于设备独立像素（dp）的尺寸单位。GXSize类通过`dpToPx()`方法将dp值转换为实际像素值。

```kotlin
fun Float.dpToPx(): Float {
    return (TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, this, Resources.getSystem().displayMetrics)).roundToInt().toFloat()
}
```

### PT单位处理
PT单位是基于屏幕尺寸的相对单位。GXSize类通过`ptToPx()`方法将pt值转换为实际像素值，考虑了屏幕宽度和高度的最小值。

```kotlin
fun Float.ptToPx(): Float {
    val screenWidthPx = GXScreenUtils.getScreenWidthPx(GXTemplateEngine.instance.context)
    val screenHeightPx = GXScreenUtils.getScreenHeightPx(GXTemplateEngine.instance.context)
    val dpToPx = 375F.dpToPx()
    var ratio = (Math.min(screenWidthPx, screenHeightPx)) / dpToPx
    GXRegisterCenter.instance.extensionSize?.convert(ratio)?.let {
        ratio = it
    }
    return (this.dpToPx() * Math.max(ratio, 1F)).roundToInt().toFloat()
}
```

### 百分比单位处理
百分比单位是基于父容器尺寸的相对单位。GXSize类通过`convertPE()`方法将百分比值转换为浮点数。

```kotlin
private fun convertPE(value: String) = value.replacePeToEmpty().toFloat() / 100F
```

**Section sources**
- [GXSize.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXSize.kt#L59-L63)
- [GXSize.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXSize.kt#L65-L78)
- [GXSize.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXSize.kt#L88-L90)

## 屏幕适配与动态缩放机制

### 屏幕尺寸获取
GXScreenUtils类提供了获取屏幕宽度和高度的方法，用于计算相对尺寸。

```kotlin
fun getScreenWidthPx(context: Context): Float {
    initScreen(context)
    return screenWidth
}

fun getScreenHeightPx(context: Context): Float {
    initScreen(context)
    return screenHeight
}
```

### 动态缩放
通过GXRegisterCenter注册的扩展功能，可以实现动态缩放。例如，`extensionSize`可以用于自定义尺寸转换逻辑。

```kotlin
class GXExtensionSize : GXRegisterCenter.GXIExtensionSize {
    override fun create(value: String): Float? {
        if ("gaiax_font" == value) {
            return 20F
        }
        if (value == "gaiax_dimen") {
            return 100F
        }
        return null
    }

    override fun convert(value: Float): Float? {
        return responsiveLayoutScale
    }
}
```

**Section sources**
- [GXScreenUtils.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/utils/GXScreenUtils.kt#L42-L50)
- [GXRegisterCenter.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/GXRegisterCenter.kt#L208-L211)
- [GXBaseTest.kt](file://GaiaXAndroid/src/androidTest/java/com/alibaba/gaiax/GXBaseTest.kt#L117-L147)

## GXStyleConvert协同工作机制

### 样式转换流程
GXStyleConvert类通过静态方法将CSS样式中的尺寸值转换为GXSize对象。例如，`font()`方法将字体大小字符串转换为GXSize对象。

```kotlin
fun font(target: String): GXSize = GXSize.create(target)
```

### 多属性处理
GXStyleConvert类提供了处理多个相关属性的方法，如`padding()`方法可以处理padding-left、padding-right等属性。

```kotlin
fun padding(cssJson: JSONObject): Rect<GXSize>? {
    var result: Rect<GXSize>? = null
    val edgeInsets = GXContainerConvert.edgeInsets(cssJson.getString(GXTemplateKey.GAIAX_LAYER_EDGE_INSETS))

    cssJson.getString(GXTemplateKey.FLEXBOX_PADDING)?.also {
        val size = GXSize.create(it)
        result = Rect(size, size, size, size)
    }

    cssJson.getString(GXTemplateKey.FLEXBOX_PADDING_LEFT)?.let {
        if (result == null) {
            result = Rect(GXSize.Undefined, GXSize.Undefined, GXSize.Undefined, GXSize.Undefined)
        }
        result?.start = GXSize.create(it)
    }
    // ... 其他属性处理
    return result
}
```

**Section sources**
- [GXStyleConvert.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXStyleConvert.kt#L229-L229)
- [GXStyleConvert.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXStyleConvert.kt#L67-L129)

## 初学者入门指南

### 基本尺寸定义
对于初学者，建议从基本的px单位开始，逐步了解pt和百分比单位的使用。

```kotlin
val size = GXSize.create("14px")
```

### 简单样式应用
通过GXStyleConvert类的静态方法，可以轻松地将CSS样式转换为GXStyle对象。

```kotlin
val style = GXStyle.create(cssJson)
```

## 高级开发者指南

### 尺寸继承
高级开发者可以利用GXFlexBox和GXStyle的继承机制，实现复杂的布局效果。

```kotlin
fun updateByVisual(visual: GXFlexBox) {
    visual.display?.let {
        displayForExtend = it
    }
    // ... 其他属性继承
}
```

### 嵌套计算
通过GXFlexBox的嵌套计算，可以实现复杂的布局结构。

```kotlin
val maxSize: Size<GXSize?>?
val minSize: Size<GXSize?>?
val size: Size<GXSize?>?
```

### 性能优化
利用GXRegisterCenter的扩展功能，可以实现自定义的性能优化策略。

```kotlin
class GXExtensionDynamicProperty : GXRegisterCenter.GXIExtensionDynamicProperty {
    override fun convert(params: GXRegisterCenter.GXIExtensionDynamicProperty.GXParams): Any? {
        if (params.propertyName == GXTemplateKey.FLEXBOX_SIZE || params.propertyName == GXTemplateKey.FLEXBOX_MIN_SIZE || params.propertyName == GXTemplateKey.FLEXBOX_MAX_SIZE) {
            @Suppress("UNCHECKED_CAST") val newValue = params.value as Size<Dimension>
            val fontName = params.cssStyle?.fontSize?.name
            if (fontName == "gaiax_font") {
                val height = newValue.height
                if (height is Dimension.Points) {
                    newValue.height = Dimension.Points(height.points * largeFontScale)
                }
                return params.value
            }
        } else if (params.propertyName == GXTemplateKey.STYLE_FONT_LINE_HEIGHT) {
            val fontName = params.cssStyle?.fontSize?.name
            if (fontName == "gaiax_font") {
                val newValue = params.value as Float
                return newValue * largeFontScale
            }
        }
        return null
    }
}
```

**Section sources**
- [GXFlexBox.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXFlexBox.kt#L261-L419)
- [GXStyle.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXStyle.kt#L396-L466)
- [GXBaseTest.kt](file://GaiaXAndroid/src/androidTest/java/com/alibaba/gaiax/GXBaseTest.kt#L90-L115)

## 实际应用示例

### 复杂布局中的尺寸处理
在复杂布局中，可以结合使用多种尺寸单位和样式属性。

```kotlin
val cssJson = JSONObject()
cssJson.put(GXTemplateKey.FLEXBOX_SIZE_WIDTH, "50%")
cssJson.put(GXTemplateKey.FLEXBOX_SIZE_HEIGHT, "100px")
cssJson.put(GXTemplateKey.FLEXBOX_MARGIN, "10pt")
val flexBox = GXFlexBoxConvert.size(cssJson)
```

### 响应式设计实现
通过百分比单位和动态缩放，可以实现响应式设计。

```kotlin
val screenWidth = GXScreenUtils.getScreenWidthPx(context)
val size = (screenWidth * 0.5).toString() + "px"
val gxSize = GXSize.create(size)
```

### 跨设备适配方案
结合屏幕尺寸获取和动态缩放，可以实现跨设备适配。

```kotlin
val screenWidth = GXScreenUtils.getScreenWidthPx(context)
val screenHeight = GXScreenUtils.getScreenHeightPx(context)
val ratio = Math.min(screenWidth, screenHeight) / 375F.dpToPx()
val scaledSize = (14F * ratio).toString() + "px"
val gxSize = GXSize.create(scaledSize)
```

**Section sources**
- [GXFlexBoxConvert.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXFlexBoxConvert.kt#L26-L38)
- [GXScreenUtils.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/utils/GXScreenUtils.kt#L42-L50)
- [GXSize.kt](file://GaiaXAndroid/src/main/kotlin/com/alibaba/gaiax/template/GXSize.kt#L69-L78)

## 结论
GaiaX Android尺寸系统通过GXSize类和GXStyleConvert类的协同工作，为开发者提供了强大而灵活的尺寸处理能力。无论是初学者还是高级开发者，都可以通过理解和应用这些机制，实现高质量的跨设备响应式布局。